# PRD v1.0 – nificdc

## 1. 프로젝트 개요

### 1.1 프로젝트 명
nificdc

### 1.2 목적
외부 Oracle DB의 데이터를 Apache NiFi 1.28을 사용하여 timestamp 기반 CDC 방식으로 수집하고, Elasticsearch로 안정적으로 적재하는 확장 가능한 CDC 파이프라인을 구축한다.

본 프로젝트는 다음을 핵심 목표로 한다.
- NiFi CDC 아키텍처의 표준화
- SQL / Flow / 테스트의 코드화
- Claude Code 기반 AI Agent 주도 구현
- 테이블 수 확장(1 → 10+)에 대비한 구조적 설계

---

## 2. 범위 정의

### 2.1 In Scope
- Oracle → NiFi → Elasticsearch CDC 파이프라인
- Kubernetes 상 NiFi 단일 노드 배포
- SQL Registry + LookupService 기반 SQL 중앙 관리
- 분 단위(range) CDC 운영
- TDD 기반 테스트 설계 및 구현
- Claude Code를 통한 NiFi Flow JSON 자동 생성

### 2.2 Out of Scope
- DELETE 처리 (완전히 제외)
- soft delete 컬럼 사용
- redo log 기반 CDC
- NiFi 클러스터 구성
- Elasticsearch 클러스터 운영

---

## 3. 환경 및 제약 사항

### 3.1 인프라 환경

| 항목 | 내용 |
|------|------|
| Kubernetes | 이미 존재, kubectl 접근 가능 |
| NiFi | Apache NiFi 1.28, `apache/nifi:1.28.1` |
| NiFi 구성 | 단일 노드 |
| Oracle | 로컬 Docker (테스트용), `absolutapps/oracle-12c-ee:latest` |
| Elasticsearch | 로컬 Docker, 인덱스 삭제/재생성 허용 |

### 3.2 Oracle 관련 설정
- 로컬 Docker 컨테이너로 Oracle 실행 (테스트용)
- Docker 이미지: `absolutapps/oracle-12c-ee:latest`
- 테스트용 전용 스키마 계정 직접 생성
- Oracle 시스템 계정 사용 가능
- JDBC 접근

---

## 4. 아키텍처 개요

```
[Oracle (Local Docker)]
   ↓ JDBC
[NiFi 1.28 (K8s, Single Node)]
   ├─ SQL Registry (ConfigMap/File)
   ├─ LookupService
   ├─ QueryDatabaseTableRecord
   ├─ Range Attribute 기반 분기
   └─ PutElasticsearchRecord
           ↓
[Elasticsearch (Local Docker)]
```

---

## 5. CDC 설계 기준 (핵심)

### 5.1 CDC 방식
- Timestamp 기반 증분 CDC
- DELETE 완전 제외
- UPDATE는 overwrite(upsert)로 처리

### 5.2 CDC Key 전략
- `CDC_KEY = TIMESTAMP || LPAD(PK, N)`
- NiFi `max-value-columns` 사용
- 동일 timestamp 다중 row 안전 처리

---

## 6. Range 운영 정책 (확정)

### 6.1 Range 단위
- 분 단위 관리
- 최소: 5분
- 최대: 1440분(24시간)

### 6.2 Range 처리 원칙
- Range는 FlowFile Attribute
- 증분 상태는 NiFi Processor State
- Range 변경 시 State는 유지
- `range_from = now - 5m`
- `range_to = now`

---

## 7. SQL Registry + LookupService 설계

### 7.1 SQL 관리 방식
- SQL은 Flow 외부에 중앙 관리
- `sql_id` 기반 조회
- `sql_id = oracle.cdc.<table>.<range>`

### 7.2 SQL 필수 규칙
- `:sql_last_value` 필수 포함
- `ORDER BY CDC_KEY` 필수
- `${range_from}`, `${range_to}` attribute 사용
- 단일 SQL(one-liner) 유지

---

## 8. NiFi Flow 요구사항

### 8.1 Flow 구성 요소
- GenerateFlowFile (range, sql_id)
- LookupService (sql_id → SQL)
- UpdateAttribute (정규화)
- QueryDatabaseTableRecord
- PutElasticsearchRecord

### 8.2 Flow 산출물
- NiFi Flow JSON을 Claude Code가 직접 생성
- UI 수동 생성 금지
- Git 기반 관리

---

## 9. Elasticsearch 적재 정책
- Index 자동 삭제/재생성 허용
- `_id` = Oracle PK
- Operation: index (upsert)
- Batch 처리

---

## 10. 테스트 전략 (TDD)

### 10.1 테스트 범위

| 레벨 | 내용 |
|------|------|
| Unit | SQL Registry 검증 |
| Contract | SQL ↔ Flow 매핑 |
| Integration | Oracle → NiFi → ES |
| Regression | CDC 재실행 |

### 10.2 테스트 기준
- `ORDER BY` 누락 시 실패
- `:sql_last_value` 누락 시 실패
- 동일 데이터 중복 적재 금지
- NiFi 재기동 후 이어서 CDC 수행

---

## 11. AI Agent 활용 전략 (확정)

### 11.1 Claude Code 역할
Claude Code는 다음 산출물을 직접 생성한다.
- SQL Registry(JSON)
- NiFi Flow JSON
- Kubernetes Manifest(YAML)
- 테스트 코드
- 검증 리포트

### 11.2 사람의 역할
- `spec.yaml` 작성
- PR 리뷰 승인
- 운영 환경 반영

---

## 12. Git 저장소 구조 (확정안)

```
nificdc/
 ├─ k8s/
 │   └─ nifi.yaml
 │
 ├─ sql-registry/
 │   └─ oracle.json
 │
 ├─ flows/
 │   └─ oracle_cdc_flow.json
 │
 ├─ specs/
 │   └─ my_table.yaml
 │
 ├─ tests/
 │   ├─ unit/
 │   ├─ integration/
 │   └─ regression/
 │
 ├─ ai/
 │   └─ prompts/
 │
 └─ README.md
```

---

## 13. 성공 기준 (Acceptance Criteria)
- 단일 테이블 CDC 정상 동작
- 분 단위 range 변경 가능
- NiFi 재시작 후 데이터 누락 없음
- 테이블 추가 시 `spec.yaml`만 추가
- Claude Code 산출물로 수동 수정 없이 실행 가능
