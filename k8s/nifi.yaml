# Apache NiFi 1.28 Single Node Deployment for CDC Pipeline
# 이 파일은 Kubernetes에 NiFi를 배포하기 위한 manifest입니다.

---
apiVersion: v1
kind: Namespace
metadata:
  name: nificdc
  labels:
    app: nificdc

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nifi-config
  namespace: nificdc
data:
  nifi.properties.override: |
    nifi.web.http.host=0.0.0.0
    nifi.web.http.port=8080
    nifi.cluster.is.node=false
    nifi.state.management.embedded.zookeeper.start=false
  bootstrap.conf.override: |
    java.arg.2=-Xms2g
    java.arg.3=-Xmx4g

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sql-registry
  namespace: nificdc
data:
  oracle.json: |
    {
      "oracle.cdc.my_table.5m": {
        "sql": "SELECT ID, NAME, VALUE, UPDATED_AT FROM CDC_TEST.MY_TABLE WHERE UPDATED_AT > TO_TIMESTAMP(${range_from}, 'YYYY-MM-DD HH24:MI:SS.FF') AND UPDATED_AT <= TO_TIMESTAMP(${range_to}, 'YYYY-MM-DD HH24:MI:SS.FF') ORDER BY UPDATED_AT",
        "table": "MY_TABLE",
        "schema": "CDC_TEST",
        "range": "5m",
        "max_value_column": "UPDATED_AT"
      }
    }

---
apiVersion: v1
kind: Secret
metadata:
  name: nifi-credentials
  namespace: nificdc
type: Opaque
stringData:
  oracle.username: "cdc_user"
  oracle.password: "cdc_password"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nifi-state-pvc
  namespace: nificdc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nifi-content-pvc
  namespace: nificdc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nifi-provenance-pvc
  namespace: nificdc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nifi
  namespace: nificdc
  labels:
    app: nifi
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nifi
  template:
    metadata:
      labels:
        app: nifi
    spec:
      containers:
        - name: nifi
          image: apache/nifi:1.28.1
          ports:
            - containerPort: 8080
              name: http
            - containerPort: 8443
              name: https
          env:
            - name: NIFI_WEB_HTTP_PORT
              value: "8080"
            - name: SINGLE_USER_CREDENTIALS_USERNAME
              value: "admin"
            - name: SINGLE_USER_CREDENTIALS_PASSWORD
              value: "adminadminadmin"
            - name: ORACLE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: nifi-credentials
                  key: oracle.username
            - name: ORACLE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: nifi-credentials
                  key: oracle.password
          resources:
            requests:
              memory: "2Gi"
              cpu: "1"
            limits:
              memory: "4Gi"
              cpu: "2"
          volumeMounts:
            - name: nifi-state
              mountPath: /opt/nifi/nifi-current/state
            - name: nifi-content
              mountPath: /opt/nifi/nifi-current/content_repository
            - name: nifi-provenance
              mountPath: /opt/nifi/nifi-current/provenance_repository
            - name: sql-registry
              mountPath: /opt/nifi/sql-registry
              readOnly: true
            - name: nifi-drivers
              mountPath: /opt/nifi/drivers
          livenessProbe:
            httpGet:
              path: /nifi
              port: 8080
            initialDelaySeconds: 120
            periodSeconds: 30
            timeoutSeconds: 10
          readinessProbe:
            httpGet:
              path: /nifi
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: nifi-state
          persistentVolumeClaim:
            claimName: nifi-state-pvc
        - name: nifi-content
          persistentVolumeClaim:
            claimName: nifi-content-pvc
        - name: nifi-provenance
          persistentVolumeClaim:
            claimName: nifi-provenance-pvc
        - name: sql-registry
          configMap:
            name: sql-registry
        - name: nifi-drivers
          emptyDir: {}
      initContainers:
        - name: download-oracle-driver
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Oracle JDBC driver should be manually added or downloaded from Oracle"
              echo "Place ojdbc8.jar in /opt/nifi/drivers/"
          volumeMounts:
            - name: nifi-drivers
              mountPath: /opt/nifi/drivers

---
apiVersion: v1
kind: Service
metadata:
  name: nifi
  namespace: nificdc
  labels:
    app: nifi
spec:
  type: NodePort
  ports:
    - port: 8080
      targetPort: 8080
      nodePort: 30080
      name: http
  selector:
    app: nifi

---
apiVersion: v1
kind: Service
metadata:
  name: nifi-headless
  namespace: nificdc
  labels:
    app: nifi
spec:
  type: ClusterIP
  clusterIP: None
  ports:
    - port: 8080
      targetPort: 8080
      name: http
  selector:
    app: nifi
